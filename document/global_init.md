# グローバル変数初期化（定数式/非定数式）

## 仕様（要約）
- グローバル変数の初期化式は **定数式** と **非定数式** の両方を許可する。
- **定数式初期化** はコンパイル時に評価し、初期値を **グローバル初期値セクション** に静的に埋め込む。
  - VM はロード時にグローバル領域へコピーするため、初期化コード（`__global_init`）は生成しない。
- **非定数式初期化** は `__global_init` アクションへ順番に吐き出し、VM 起動時に必ず実行する。
- 実行順序は **`__global_init` → `init` → 通常実行** で固定。
- `__global_init` は **一度だけ** スケジュールされる（VM が実行フラグで管理）。

## 定数式初期化（Compile-time init）
- 判定対象: `int/short/char/float`（および `actor` 参照の整数値）を生成できる式。
- 判定例:
  - `int a = 3 + 4;`
  - `float f = 1.5;`
  - `int b = (1 + 2) * 3;`
- 判定不可（非定数式へフォールバック）:
  - 関数呼び出し
  - グローバル変数の参照（定数シンボル以外）

## 非定数式初期化（Runtime init）
- 例:
  - `int x = Foo();`
  - `int b = a + 1;`（`a` はグローバル変数）
- コンパイラは `__global_init` を自動生成し、グローバル宣言順に初期化コードを出力する。

## 実行順序と初期化済みの保証
- VM 起動時に `__global_init` をスケジュールし、その後 `init` をスケジュールする。
- `__global_init` は **一度だけ** スケジュールされる（VM の `GlobalInitDone` フラグで制御）。
- すべてのグローバル領域はロード時に **ゼロ初期化** されるため、`__global_init` 実行前に読み出された未初期化グローバルの値は 0 とする。

## 初期化順序の仕様
- **同一ファイル内**: ソースの宣言順（トップダウン）。
- **複数ファイル**: コンパイル・リンク順に依存（ビルドモデル依存）。別モジュール間の順序は未定義。

## 生成コードとデータ構造
- 定数式初期化は **グローバル初期値セクション**に格納。
  - バイナリ構造: `header → actor info → constant pool → global init data → instruction pool`
  - `FileHeader::mSizeOfGlobalInitData` でサイズを保持。
- 非定数式初期化は `__global_init` に集約。
  - 予約アクター名: `__global`
  - 予約アクション名: `__global_init`

## テスト観点（最低限）
- 定数式:
  - `bool a = true; int b = 3 + 4;`
- 非定数式:
  - `int x = Foo();`
- 参照順:
  - `int a = 1; int b = a + 1;`
- 多重実行:
  - VM 再ロード/再 init で `__global_init` が二重にスケジュールされないこと
