<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja">
<head>
<title>アクター指向スクリプト言語Mana</title>
<meta charset=UTF-8> 
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="author" content="Shun Moriya">
<meta name="description" content="擬似マルチスレッドを用いてゲームのイベントを効率良く開発することを目的に開発されたスクリプト言語です。コンパイラと実行ライブラリに分かれているので実行環境のみ組み込むことが可能です">
<meta name="keywords" content="アクター指向,スクリプト言語">
<link rel="stylesheet" href="style/standard.css" type="text/css" media="all">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="alternate" href="https://shun126.github.io/Mana/" hreflang="ja">
<link rel="canonical" href="https://shun126.github.io/Mana/">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-357257-8', 'auto');
  ga('send', 'pageview');
</script>
</head>

<body>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr id="siteName">
		<td><h1><a href="index.html"><img src="favicon.png"alt="Mana" border="0"></a>Mana</h1></td>
	</tr>
<tr>
<td bgcolor="#FFFFFF">
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr id="globalNav">
<td>
<a href="https://github.com/shun126/Mana/releases" class="glink">ダウンロード</a>
<a href="https://github.com/shun126/Mana/wiki" class="glink">ドキュメント</a>
<a href="https://github.com/shun126/Mana/issues" class="glink">バグ・サポート</a>
<a href="https://github.com/shun126/Mana/" class="glink">ソースコード</a>
</td>
</tr>
  <tr>
		<td bgcolor="#FFFFFF">
			<div id="breadCrumb"><a href="index.html">Home</a>
</div>
			<div id="pageName">
				<h2>アクター指向スクリプト言語</h2>
			</div>
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td align="left" valign="top">
						<div class="story">
<h2>Manaとは</h2>
<p>ゲームスクリプトと一口に言ってもプログラマが利用対象の高機能なタイプと、プランナが欲しい簡素なタイプのスクリプトがあると思います。前者はLuaやSquirrelが該当すると思いますが、後者の為のスクリプトとしてManaを開発しました。</p>
<p>Manaはプランナが制御するキャラクターの移動やアニメーション、およびメッセージの制御などを簡単な構造で記述できる事を念頭に開発しています。 その為、Manaには動的型やクラスなど今時の機能がありません。インタプリタを搭載する事が不可能なメモリの少ないプラットフォームに利用する事も考 え、コンパイラと実行環境を分離しています。このため、できるだけ記述ミスを実行前に発見できるようにしたいと考えコンパイラを強化しています。</p>
<h2>Manaの特徴</h2>
<p>Manaとはゲームのイベントを効率良く開発することを目的に開発されたスクリプトです。世の中の物事というものは、常に並行して行われています。例えば、学校で授業をしている教室においても、教壇で講義する先生、真面目に勉強している生徒、よそ見をしている生徒、無駄話をしている生徒、早弁をしている生徒と、同じ時間に行われている事柄は多種多様です。しかし、プログラムの処理というものは一つ一つの手順を踏んでいきます。従来のプログラムの手法では、このような並列的な処理というものは困難でした。これを擬似的に再現しようとしたものがManaというスクリプトです。</p>
<p>Manaは疑似並列処理を行うことを目的にしたスクリプトで、複数のアクターという単位によって構成されます。アクターとは日本語で直訳する通りに「役者」の意味であり、そのシーン(シチュエーション)に必要なアクターが、そのシーンのソースファイルの中に存在しています。そして、各アクターがお互いの動きに応じて反応しあい、一つのシーンを作り上げていきます。</p>
<h2>Manaのメリット</h2>
<p>クラスを盛り込んだオーソドックスなスクリプトシステムを作成しましたが、スレッドやオブジェクトの管理などスクリプト作成が複雑になりすぎると思いました。私は企画者が演出を記述できる単純なスクリプトシステムを望んでいたので、同様の条件を望むプログラマにManaは向いていると思います。</p>
<p>Manaはリクエストと呼ばれる割り込みで動作するシステムです。複雑な処理はプログラム側に任せて、タイミングや分岐など演出部分だけをスクリプトに任せることができます。</p>
<ul>
<li>簡単に組み込めるシンプルなエンジン</li>
<li>シンプルな文法</li>
<li>アクションをリクエストすることで</li>
<li>ダイナミックローディング(アーキテクチャによる)</li>
<li>移植性が高い。LinuxやDOS、Windows、Mac上で動くだけでなく、ゲーム機などの組み込みシステム上でも動く
</li>
</ul>
<h2>アクターとリクエスト</h2>
<p>Manaを象徴する概念が「リクエスト」です。これはアクター同士でお互いの動きを命令しあうもので、これによって並列的な動きとアクター同士の連携を実現しています。例えば、バスに乗っていて“次の停留所が告げられたときに、そこで降りる人が複数いて、同時多発的にボタンを押そうとした”というシチュエーションを考えてみましょう。</p>
<p>
まず、「バス」というアクターから「次の停留所で降りるアクターはボタンを押せ」というリクエストが「乗客」アクター全員に発せられます。「乗客」アクターの中で該当するアクターが「ボタンを押せ」というリクエストを受け取って実行します。このとき、該当する「乗客」アクターは他に何かしていても(例えば本を読んでいたり、他の人と話していたり、窓の外を見ていたり)、それらを中断してボタンを押そうとします。つまり「ボタンを押せ」というリクエストはその時にアクターがしている動作よりも優先されます。これが「プライオリティ（優先度）」です。</p>
<p>
アクターは特に命令がない限り、他の動作をしています。これは一番低いレベルのリクエストを実行しているのと同じ事です。しかし、それよりも優先して行われるべきリクエストが来た場合、それまでしていたことを中断して、そのリクエストを実行しようとします。逆に、あるレベルのリクエストを実行しているときに、それよりも下位のリクエストが来た場合には、現在行われているリクエストが終了するまで、新たに来たリクエストを実行しないで待機させます。</p>
<p>
図１を見ていただくとリクエストの動作が分かりやすいと思います。実行中のレベルよりもプライオリティの高い要求は即座に実行し、プライオリティの低い要求は終了後に実行されます。</p>
<p align="center">図１　プライオリティとリクエストの関係<br>
<img src="priority.png" width="466" height="217">
</p>
<p>図1はMさんの週末の生活です。プライオリティ１でMさんは昼寝をしていましたが、その後プライオリティ３で、テレビを見たい欲求がおこりました。Mさんは食器を洗っていないことを思い出しましたが、プライオリティ２程度の要求だったので、テレビを見た後にしようと思いました。ところが、プライオリティ４で、恐妻がMさんに風呂掃除(とトイレ掃除)を要求してきました。Mさんはテレビを見ることを中断して掃除を始めます。掃除終了後、優先度３のテレビを見る処理に戻ります。そして、テレビ番組が終了したので、優先度２の食器洗いを嫌々始めます。</p>
<p>上記のようにアクションが終了すると現在よりも低いプライオリティで登録されたアクションに戻ります。また、今までの処理をキャンセルする事も可能です。会社で居眠りしていたイベントを考えた場合、上司に注意された後再び居眠りするアクションに戻るようでは困る事があります。こういった状況のためにManaではアクション終了時にどのプライオリティまで下がるか指定することが出来ます(rollback命令)。</p>
<h2>Manaでイベントを作るには</h2>
<p>では実際にソースを書く場合、どのような書式になるのでしょう。例１がManaのスクリプトの表記です。</p>
<p align="center">例１ 初めてのManaソース</p>
<blockquote>
<pre>actor Mr_M
{
    action init()
    {
        print(&quot;Hello, world\n&quot;);
        request(1, self::sleep);
    }
    action sleep()
    {
        // 寝るアニメーションを再生
        request(3, self::watchTV);
    }
    action watchTV
    {
        // テレビを見るアニメーションを再生
        request(2, self::washDish);
        // 番組が終わるまで待機
    }
    action washDish()
    {
        // 食器洗いアニメーションを再生
    }
    action cleanBathRoom()
    {
        // 風呂掃除アニメーションを再生
    }
}

actor LovelyWife
{
    action orderCleanBathRoom()
    {
        // 風呂掃除を要求
        request(4, Mr_M::cleanBathRoom);
    }
}
</pre>
</blockquote>
<p>{～}で囲まれた部分、または;までの行をブロックと呼びます。actorブロックは先ほど紹介したアクターに当たる部分です。actionブロックはアクターの行動を定義するブロックです。アクションブロックの名前は予約された名前以外は自由に決めることができます。アクションブロック内に行動を記述することでキャラクターの行動を定義することができます。</p>
<h2>その他の情報</h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2">
<tr>
<td nowrap width="1%">動作環境</td>
<td>非常に移植性が高くほとんどの環境で動作します</td>
</tr>
<tr>
<td nowrap width="1%">対象ユーザ</td>
<td>開発者</td>
</tr>
<tr>
<td nowrap width="1%">ライセンス</td>
<td>zlib/libpng License</td>
</tr>
<tr>
<td nowrap width="1%">オペレーティングシステム</td>
<td>OS非依存</td>
</tr>
<tr>
<td nowrap width="1%">プログラミング言語</td>
<td>C言語</td>
</tr>
</table>
<p>Manaはある程度様々なゲームに利用できるよう言語仕様のみを取り決め、ゲームに必要な命令は外部から登録して利用するようになっています。画像１はサンプルになるゲームのイベントシーンです。中央の主人公はもちろんの事、主人公の触れるドアなどもactorで管理できます。</p>
<p align="center">画像１　参考画面<br>
<a href="gd_framework_l.jpg"><img src="gd_framework_s.jpg" width="384" height="246" border="1" alt="参考画面"></a></p>
<h2>詳しい情報</h2>
<p>その他の詳しい情報は<a href="https://github.com/shun126/Mana/wiki">文章ページ</a>に随時アップロードしていきますのでご参照ください。また、バグ報告やサポート希望は<a href="https://github.com/shun126/Mana/issues">チケットページ</a>をお気軽にご利用ください。</p>
</div>
						</div>
						<div class="date" align="center">
							<script type="text/javascript">
<!--
document.write('This page was updated:' + document.lastModified);
// -->
</script>
						</div>
					</td>

<td align="left" valign="top" width="200" bgcolor="#F5f7f7">

<div id="sectionLinks">
<h3>ビルド状況</h3>
<a href="https://travis-ci.org/shun126/Mana"><img src="https://travis-ci.org/shun126/Mana.svg?branch=master"></a>
<h3>リンク</h3>
<a href="https://github.com/shun126/Mana/releases">ダウンロード</a>
<a href="https://github.com/shun126/Mana/wiki">ドキュメント</a>
<a href="https://github.com/shun126/Mana/issues">バグ・サポート</a>
<a href="https://github.com/shun126/Mana/">ソースコード</a>
<h3>Doxygen</h3>
<a href="doxygen/compiler/html/index.html">コンパイラ</a>
<a href="doxygen/library/html/index.html">ランタイム</a>
</div>

<br>

<div id="advert">
</div>

<br>

</td>

				</tr>
			</table>
		</td>
	</tr>
  <tr>
		<td id="siteInfo">Shun Moriya</td>
	</tr>
</table>
</body>
</html>